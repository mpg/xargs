%% Math macros with multiple optional parameters
% #1<-\foo
\def\newlyxcommand#1{
  \@ifnextchar[%]
  {\newlyxcommand@arity{#1}}
  {\newlyxcommand@arity{#1}[0]}
  }

% #1<-\foo #2<-arity
\def\newlyxcommand@arity#1[#2]{
  \@ifnextchar[%]
  {\newlyxcommand@firstopt{#1}{}{#2}}
  {\newlyxcommand@def#1{#2}}
  }

% #1<-\foo #2<-iii #3<-arity #4<-default value for (#2+1)th argument
\def\newlyxcommand@firstopt#1#2#3[#4]{
  % ##1<-\foo@
  \def\@defclause##1{
    \def#1{
      \@ifnextchar[%]
      {##1{}{#4}}
      {##1{}{#4}[#4]}}
    }
  \expandafter\@defclause\csname\expandafter\@gobble\string#1@\endcsname
  \@ifnextchar[%]
  {\newlyxcommand@opt{#1}{#2}{#3}}
  {\newlyxcommand@last{#1}{#2}{#3}[#4]}
  }

\begingroup
\catcode`\Q=3
\gdef\@myempty{Q}
\endgroup

% #1<-\foo #2<-iii #3<-arity #4<-default value for (#2+1)th argument
\def\newlyxcommand@opt#1#2#3[#4]{
  % ##1<-\foo@iii ##2<-\foo@iiii 
  % ####1<-{a}{b}{c} ####2<-default value ####3<- default arg
  \def\@defclause##1##2{
    \def##1####1####2[####3]{
      \ifx\@myempty####3\@myempty%
        \def\@callnext{
          \@ifnextchar[%]
          {##2{####1{####2}}{#4}}
          {##2{####1{####2}}{#4}[#4]}
          }
      \else
        \def\@callnext{
          \@ifnextchar[%]
          {##2{####1{####3}}{#4}}
          {##2{####1{####3}}{#4}[#4]}
          }
      \fi
      \@callnext
      }
    }
  \expandafter\def\expandafter\@clausename\expandafter{\csname\expandafter\@gobble\string#1@#2\endcsname}
  \expandafter\def\expandafter\@nextclausename\expandafter{\csname\expandafter\@gobble\string#1@#2i\endcsname}
  \expandafter\expandafter\expandafter  
  \@defclause\expandafter\@clausename\@nextclausename
  \@ifnextchar[%]
  {\newlyxcommand@opt{#1}{#2i}{#3}}
  {\newlyxcommand@last{#1}{#2i}{#3}[#4]}
  }

% #1<-\foo #2<-iii #3<-arity #4<-default value for (#2+1)th argument
\def\newlyxcommand@last#1#2#3[#4]{
  \def\@defclause##1##2{
    \def##1####1####2[####3]{
      \ifx\@myempty####3\@myempty%
        \def\@callnext{##2####1{####2}}
      \else
        \def\@callnext{##2####1{####3}}
      \fi
      \@callnext
      }
    }
  \expandafter\def\expandafter\@clausename\expandafter{\csname\expandafter\@gobble\string#1@#2\endcsname}
  \expandafter\def\expandafter\@nextclausename\expandafter{\csname\expandafter\@gobble\string#1@#2i\endcsname}
  \expandafter\expandafter\expandafter
  \@defclause\expandafter\@clausename\@nextclausename
  \expandafter\newlyxcommand@def\csname\expandafter\@gobble\string#1@#2i\endcsname{#3}
  }

% #1<-\foo #2<-arity #3<-definition
\def\newlyxcommand@def#1#2#3{
  \ifx#20
    \def#1{#3}
  \else
    \def\@splitargs##1#2##2.{\def#1##1#2}\@splitargs##1##2##3##4##5##6##7##8##9.{#3}
  \fi
  } 

%vim% tex_stylish
